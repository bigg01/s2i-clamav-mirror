#!/bin/bash

set -e
set -o pipefail

echo "Before assembling"

/usr/libexec/s2i/assemble
rc=$?

if [ $rc -eq 0 ]; then
    echo "After successful assembling"
else
    echo "After failed assembling"
fi

echo "---> Getting ClamAV files"

CLAMAV_FILES="main.cvd daily.cvd bytecode.cvd"

echo "files: $CLAMAV_FILES"
#CLAMAV_MIRROR=${CLAMAV_MIRROR_REMOTE:-"https://database.clamav.net"}
CLAMAV_MIRROR="https://database.clamav.net"

echo "from mirror: $CLAMAV_MIRROR"
rc=$(($rc + $?))

echo $rc

for f in $CLAMAV_FILES
 do
    REMOTE_FILE=${CLAMAV_MIRROR/${f}
    echo "$REMOTE_FILE"
    curl -L "$REMOTE_FILE" --output ./${f} --silent
done

# Fix source directory permissions
fix-permissions ./
#rc=$(($rc + $?))    

echo $rc

#if [ $rc -eq 0 ]; then
#    echo "ClamAV get files successfull"
#else
#    echo "ClamAV get files failed"
#fi

exit $rc

#!/bin/bash

set -e
set -o pipefail

echo "Before assembling"

/usr/libexec/s2i/assemble
rc=$?

if [ $rc -eq 0 ]; then
    echo "After successful assembling"
else
    echo "After failed assembling"
fi

echo "---> Getting ClamAV files"

CLAMAV_FILES="main.cvd daily.cvd bytecode.cvd"
CLAMAV_MIRROR="${CLAMAV_MIRROR_REMOTE:-\"https://database.clamav.net\"}"

for f in $CLAMAV_FILES
 do
    curl -L "${CLAMAV_MIRROR/${f}" --output "${f}" --silent
    rc=$(($rc + $?)) 
    cp -pv ${f} ./ 
    rc=$(($rc + $?))
    rm -f ${f}
done

# Fix source directory permissions
fix-permissions ./
rc=$(($rc + $?))    


if [ $rc -eq 0 ]; then
    echo "ClamAV get files successfull"
else
    echo "ClamAV get files failed"
fi

exit $rc
